<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼</title>
<style>
body { font-family:sans-serif; text-align:center; padding:20px; }
button { font-size:20px; padding:20px; width:100%; }
#status { margin:20px; font-weight:bold; }
</style>
</head>
<body>

<div id="status">èµ·å‹•ä¸­â€¦</div>
<button id="talk">æŠ¼ã—ã¦è©±ã™</button>

<script>
let ctx, mic, gain;
let pc, localStream;

/* ===== å…±é€š ===== */
function show(text){ status.textContent = text; }

async function initAudio() {
  if (ctx) return;
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({
    audio:{
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  });
  mic = ctx.createMediaStreamSource(stream);
  gain = ctx.createGain();
  gain.gain.value = 0;
  mic.connect(gain).connect(ctx.destination);
}

/* ===== 1å°ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰ ===== */
async function startOffline() {
  show("âœˆï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆ1å°ãƒ¢ãƒ¼ãƒ‰ï¼‰");
  await initAudio();
}

/* ===== 2å°ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼‰ ===== */
async function startOnline() {
  show("ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆ2å°ãƒ¢ãƒ¼ãƒ‰ï¼‰");

  localStream = await navigator.mediaDevices.getUserMedia({audio:true});

  pc = new RTCPeerConnection();

  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.ontrack = e => {
    const a = document.createElement("audio");
    a.srcObject = e.streams[0];
    a.autoplay = true;
  };

  // âš ï¸ ã“ã“ãŒã€Œä¸­ç¶™ï¼ˆsignalingï¼‰ã€éƒ¨åˆ†
  // å®Ÿéš›ã¯ Firebase / WebSocket ã«å·®ã—æ›¿ãˆã‚‹
  show("ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆâ€»ä¸­ç¶™æœªæ¥ç¶šï¼‰");
}

/* ===== ãƒ¢ãƒ¼ãƒ‰è‡ªå‹•åˆ¤å®š ===== */
async function updateMode() {
  if (navigator.onLine) {
    await startOnline();
  } else {
    await startOffline();
  }
}

window.addEventListener("online", updateMode);
window.addEventListener("offline", updateMode);

/* ===== PTT ===== */
talk.onmousedown = () => gain && (gain.gain.value = 1);
talk.onmouseup   = () => gain && (gain.gain.value = 0);
talk.ontouchstart = () => gain && (gain.gain.value = 1);
talk.ontouchend   = () => gain && (gain.gain.value = 0);

/* ===== åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ ===== */
document.body.addEventListener("click", async ()=>{
  if (ctx && ctx.state==="suspended") await ctx.resume();
  updateMode();
},{once:true});
</script>

</body>
</html>
