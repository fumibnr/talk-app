<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼</title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #111;
  color: #fff;
}
#status {
  font-size: 22px;
  margin: 20px;
  padding: 10px;
  border-radius: 10px;
  background: #333;
}
button {
  font-size: 28px;
  padding: 20px 40px;
  border-radius: 20px;
  border: none;
}
.ptt {
  background: red;
  color: white;
}
</style>
</head>

<body>

<h1>ğŸ“» ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼</h1>

<div id="status">èµ·å‹•ä¸­â€¦</div>

<button id="ptt" class="ptt">æŠ¼ã—ã¦è©±ã™</button>

<script>
let ctx;
let pc = null;
let peerConnected = false;
let localAudio = null;

const statusEl = document.getElementById("status");
const ptt = document.getElementById("ptt");

function setStatus(txt) {
  statusEl.textContent = txt;
}

// ===== ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ / ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡º =====
function updateOnlineStatus() {
  if (!navigator.onLine) {
    setStatus("âœˆï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼ˆ1å°ãƒ¢ãƒ¼ãƒ‰ï¼‰");
  } else if (peerConnected) {
    setStatus("ğŸ”— æ¥ç¶šä¸­ï¼ˆ2å°ãƒˆãƒ©ãƒ³ã‚·ãƒ¼ãƒãƒ¼ï¼‰");
  } else {
    setStatus("ğŸŒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆå¾…æ©Ÿãƒ»1å°ï¼‰");
  }
}
window.addEventListener("online", updateOnlineStatus);
window.addEventListener("offline", updateOnlineStatus);

// ===== WebRTC è¶…ç°¡æ˜“æ¥ç¶šï¼ˆåŒURLæƒ³å®šï¼‰=====
async function setupPeer() {
  if (!navigator.onLine) return;

  pc = new RTCPeerConnection();

  pc.ontrack = e => {
    const a = new Audio();
    a.srcObject = e.streams[0];
    a.play();
  };

  pc.onicecandidate = e => {
    if (e.candidate) {
      localStorage.setItem("ice", JSON.stringify(e.candidate));
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  localStorage.setItem("offer", JSON.stringify(offer));

  window.addEventListener("storage", async e => {
    if (e.key === "offer" && !pc.currentRemoteDescription) {
      await pc.setRemoteDescription(JSON.parse(e.newValue));
      const ans = await pc.createAnswer();
      await pc.setLocalDescription(ans);
      localStorage.setItem("answer", JSON.stringify(ans));
      peerConnected = true;
      updateOnlineStatus();
    }
    if (e.key === "answer" && !pc.currentRemoteDescription) {
      await pc.setRemoteDescription(JSON.parse(e.newValue));
      peerConnected = true;
      updateOnlineStatus();
    }
  });
}

// ===== 1å°ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è¿”ã—ï¼‰=====
function localMonitor(stream) {
  ctx = new (window.AudioContext || window.webkitAudioContext)();
  const src = ctx.createMediaStreamSource(stream);
  src.connect(ctx.destination);
}

// ===== PTT =====
ptt.onmousedown = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  if (!navigator.onLine || !peerConnected) {
    localMonitor(stream);
    return;
  }

  stream.getTracks().forEach(t => pc.addTrack(t, stream));
};

ptt.onmouseup = () => {
  if (ctx) {
    ctx.close();
    ctx = null;
  }
};

// åˆæœŸåŒ–
setupPeer();
updateOnlineStatus();

// Service Workerï¼ˆPWAï¼‰
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
